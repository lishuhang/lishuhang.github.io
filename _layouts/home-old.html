---
layout: base
---

<div class="blog-container">
  <!-- 侧边栏 -->
  <aside class="blog-sidebar" id="blogSidebar">
    <div class="blog-sidebar-header">
      <a href="{{ site.url }}" class="sidebar-logo-link">
        <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="sidebar-logo-image">
      </a>
      <a href="{{ site.url }}" class="blog-sidebar-title">{{ site.title }}</a>
    </div>
    
    <div class="blog-sidebar-body">
      <!-- 搜索框 -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索文章..." class="search-input">
      </div>
      
      <!-- 标签区域 -->
      <div class="tags-section">
        <label class="section-label">标签</label>
        <div class="tags-container" id="tagsContainer">
          {% assign all_tags = site.posts | map: 'tags' | join: ',' | split: ',' | uniq | sort %}
          {% for tag in all_tags %}
            {% if tag != "" %}
            <a href="#" class="tag-btn" data-tag="{{ tag }}">{{ tag }}</a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- 年份选择器 -->
      <div class="year-selector">
        <label class="section-label">选择年份</label>
        <div id="yearContainer">
          {% assign posts_by_year = site.posts | group_by_exp: "post", "post.date | date: '%Y'" %}
          {% for year_group in posts_by_year %}
          <div class="year-section">
            <div class="year-header" data-year="{{ year_group.name }}">
              <span class="year-title">{{ year_group.name }}年 ({{ year_group.items | size }}篇)</span>
              <svg class="year-icon collapsed" viewBox="0 0 12 12" fill="currentColor">
                <path d="M6 8.825c-.2 0-.4-.1-.5-.2l-3.3-3.3c-.3-.3-.3-.8 0-1.1.3-.3.8-.3 1.1 0l2.7 2.7 2.7-2.7c.3-.3.8-.3 1.1 0 .3.3.3.8 0 1.1l-3.2 3.2c-.2.2-.4.3-.6.3Z"/>
              </svg>
            </div>
            <div class="year-content" id="year-{{ year_group.name }}">
              <a href="#" class="year-link" data-year="{{ year_group.name }}">查看本年度所有文章</a>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- 版权信息 -->
      <div class="copyright">
        © {{ site.name | default: site.title }}
      </div>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="blog-main" id="blogMain">
    <div id="postsContainer">
      {% for post in site.posts limit: 12 %}
      <article class="post-card" data-year="{{ post.date | date: '%Y' }}" data-tags="{{ post.tags | join: ',' }}">
        <a href="{{ post.url | relative_url }}" class="post-card-link">
          {% if post.image %}
          <div class="post-card-image">
            <img src="{{ post.image | relative_url }}" alt="{{ post.title }}" loading="lazy">
          </div>
          {% endif %}
          <div class="post-card-content">
            <h2 class="post-card-title">{{ post.title }}</h2>
            <div class="post-card-meta">
              <span class="post-card-date">{{ post.date | date: "%Y-%m-%d" }}</span>
              {% if post.tags.size > 0 %}
              <span class="post-card-tags">
                {% for tag in post.tags limit: 3 %}
                <span class="post-tag">#{{ tag }}</span>
                {% endfor %}
              </span>
              {% endif %}
            </div>
            {% if post.excerpt %}
            <p class="post-card-excerpt">{{ post.excerpt | strip_html | truncatewords: 30 }}</p>
            {% endif %}
          </div>
        </a>
      </article>
      {% endfor %}
    </div>
    
    <div id="loadingIndicator" class="loading" style="display: none;">
      正在加载更多文章...
    </div>
    
    <div id="noMorePosts" class="no-more" style="display: none;">
      没有更多文章了
    </div>
  </main>
</div>

<!-- 移动端标题栏 -->
<div class="mobile-header">
  <div class="mobile-header-logo">
    <a href="{{ site.url }}">
      <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="logo-image">
    </a>
    <a href="{{ site.url }}" class="logo-text">{{ site.title }}</a>
  </div>
  <button class="hamburger-button" id="hamburgerButton" aria-label="打开菜单">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>
</div>

<!-- 移动端遮罩层 -->
<div class="sidebar-overlay" id="sidebarOverlay">
  <button class="close-button" id="closeButton" aria-label="关闭菜单">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</div>

<script>
// 全局变量
let allPosts = [];
let filteredPosts = [];
let currentFilter = { type: null, value: null };
let displayedCount = 12;
const postsPerLoad = 12;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing blog...');
  
  // 收集所有文章数据
  collectAllPosts();
  
  // 绑定事件
  bindEvents();
  
  // 初始化无限滚动
  initInfiniteScroll();
  
  console.log('Blog initialized');
});

// 收集所有文章数据
function collectAllPosts() {
  const postCards = document.querySelectorAll('.post-card');
  allPosts = Array.from(postCards).map(card => ({
    element: card,
    year: card.dataset.year,
    tags: card.dataset.tags ? card.dataset.tags.split(',') : [],
    title: card.querySelector('.post-card-title').textContent.toLowerCase(),
    excerpt: card.querySelector('.post-card-excerpt')?.textContent.toLowerCase() || ''
  }));
  filteredPosts = [...allPosts];
  console.log('Collected posts:', allPosts.length);
}

// 绑定事件
function bindEvents() {
  // 搜索
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(handleSearch, 300));
  }
  
  // 标签点击
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const tag = e.target.dataset.tag;
      handleTagClick(tag, e.target);
    });
  });
  
  // 年份展开/折叠
  document.querySelectorAll('.year-header').forEach(header => {
    header.addEventListener('click', (e) => {
      const year = e.currentTarget.dataset.year;
      toggleYear(year);
    });
  });
  
  // 年份链接点击
  document.querySelectorAll('.year-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const year = e.target.dataset.year;
      handleYearClick(year);
    });
  });
  
  // 移动端菜单
  const hamburgerButton = document.getElementById('hamburgerButton');
  if (hamburgerButton) {
    hamburgerButton.addEventListener('click', toggleMobileSidebar);
  }
  
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', (e) => {
      if (e.target === sidebarOverlay) {
        closeMobileSidebar();
      }
    });
  }
  
  const closeButton = document.getElementById('closeButton');
  if (closeButton) {
    closeButton.addEventListener('click', closeMobileSidebar);
  }
}

// 搜索处理
function handleSearch(e) {
  const query = e.target.value.toLowerCase().trim();
  console.log('Search query:', query);
  
  if (query === '') {
    // 清空搜索，恢复之前的过滤
    if (currentFilter.type) {
      applyFilter(currentFilter.type, currentFilter.value);
    } else {
      filteredPosts = [...allPosts];
      displayedCount = 12;
      renderPosts();
    }
    return;
  }
  
  // 搜索文章
  filteredPosts = allPosts.filter(post => 
    post.title.includes(query) || post.excerpt.includes(query)
  );
  
  displayedCount = Math.min(12, filteredPosts.length);
  renderPosts();
}

// 标签点击处理
function handleTagClick(tag, element) {
  // 切换激活状态
  const wasActive = element.classList.contains('active');
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  if (wasActive) {
    // 取消过滤
    currentFilter = { type: null, value: null };
    filteredPosts = [...allPosts];
    displayedCount = 12;
  } else {
    // 应用标签过滤
    element.classList.add('active');
    currentFilter = { type: 'tag', value: tag };
    filteredPosts = allPosts.filter(post => post.tags.includes(tag));
    displayedCount = Math.min(12, filteredPosts.length);
  }
  
  // 清空搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  renderPosts();
}

// 年份点击处理
function handleYearClick(year) {
  console.log('Year clicked:', year);
  
  // 应用年份过滤
  currentFilter = { type: 'year', value: year };
  filteredPosts = allPosts.filter(post => post.year === year);
  displayedCount = Math.min(12, filteredPosts.length);
  
  // 清空搜索框和标签选择
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  renderPosts();
  
  // 关闭移动端侧边栏
  closeMobileSidebar();
}

// 年份展开/折叠
function toggleYear(year) {
  const header = document.querySelector(`[data-year="${year}"]`);
  const content = document.getElementById(`year-${year}`);
  const icon = header.querySelector('.year-icon');
  
  const isExpanded = content.classList.contains('expanded');
  
  if (isExpanded) {
    content.classList.remove('expanded');
    icon.classList.remove('expanded');
    icon.classList.add('collapsed');
    header.classList.remove('expanded');
  } else {
    content.classList.add('expanded');
    icon.classList.add('expanded');
    icon.classList.remove('collapsed');
    header.classList.add('expanded');
  }
}

// 渲染文章列表
function renderPosts() {
  const container = document.getElementById('postsContainer');
  const noMorePosts = document.getElementById('noMorePosts');
  
  // 隐藏所有文章
  allPosts.forEach(post => {
    post.element.style.display = 'none';
  });
  
  // 显示过滤后的文章
  const postsToShow = filteredPosts.slice(0, displayedCount);
  postsToShow.forEach(post => {
    post.element.style.display = 'block';
  });
  
  // 更新"没有更多"提示
  if (displayedCount >= filteredPosts.length) {
    noMorePosts.style.display = filteredPosts.length === 0 ? 'none' : 'block';
  } else {
    noMorePosts.style.display = 'none';
  }
  
  console.log(`Rendered ${postsToShow.length} of ${filteredPosts.length} posts`);
}

// 无限滚动
function initInfiniteScroll() {
  const blogMain = document.getElementById('blogMain');
  const loadingIndicator = document.getElementById('loadingIndicator');
  
  blogMain.addEventListener('scroll', () => {
    const scrollTop = blogMain.scrollTop;
    const scrollHeight = blogMain.scrollHeight;
    const clientHeight = blogMain.clientHeight;
    
    // 距离底部200px时加载更多
    if (scrollHeight - scrollTop - clientHeight < 200) {
      loadMorePosts();
    }
  });
}

// 加载更多文章
let isLoading = false;
function loadMorePosts() {
  if (isLoading || displayedCount >= filteredPosts.length) return;
  
  isLoading = true;
  const loadingIndicator = document.getElementById('loadingIndicator');
  loadingIndicator.style.display = 'block';
  
  setTimeout(() => {
    displayedCount = Math.min(displayedCount + postsPerLoad, filteredPosts.length);
    renderPosts();
    loadingIndicator.style.display = 'none';
    isLoading = false;
  }, 500);
}

// 移动端侧边栏控制
function toggleMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
  document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
}

function closeMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>

