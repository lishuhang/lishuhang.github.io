---
layout: base
---

<div class="blog-container">
  <!-- 侧边栏 -->
  <aside class="blog-sidebar" id="blogSidebar">
    <div class="blog-sidebar-header">
      <a href="#" class="sidebar-logo-link" onclick="event.preventDefault(); resetToHome();">
        <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="sidebar-logo-image">
      </a>
      <a href="#" class="blog-sidebar-title" onclick="event.preventDefault(); resetToHome();">{{ site.title }}</a>
    </div>
    
    <div class="blog-sidebar-body">
      <!-- 搜索框 -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索文章..." class="search-input">
      </div>
      
      <!-- AIGC早报链接 -->
      <div class="aigc-link-section">
        <a href="/?tag=AIGC" class="aigc-link" data-tag="AIGC">每日AIGC早报</a>
      </div>
      
      <!-- 标签区域 -->
      <div class="tags-section">
        <label class="section-label">标签</label>
        <div class="tags-container" id="tagsContainer">
          <!-- 标签将通过JavaScript动态生成 -->
        </div>
      </div>
      
      <!-- 年份选择器 - 全展开列表 -->
      <div class="year-selector">
        <label class="section-label">按年份浏览</label>
        <div class="year-list">
          {% assign posts_by_year = site.posts | group_by_exp: "post", "post.date | date: '%Y'" %}
          {% for year_group in posts_by_year %}
          {% assign aigc_posts = year_group.items | where_exp: "post", "post.tags contains 'AIGC'" %}
          {% assign total_posts = year_group.items | size %}
          {% assign aigc_count = aigc_posts | size %}
          {% assign non_aigc_count = total_posts | minus: aigc_count %}
          <a href="/?year={{ year_group.name }}" class="year-link" data-year="{{ year_group.name }}">{{ year_group.name }}年 ({{ non_aigc_count }}篇)</a>
          {% endfor %}
        </div>
      </div>
      
      <!-- 导航链接 -->
      <div class="nav-links">
        <label class="section-label">更多</label>
        <a href="{{ '/about' | relative_url }}" class="nav-link" data-page-url="{{ '/about' | relative_url }}">关于</a>
        <a href="/photos" class="nav-link" target="_blank" rel="noopener noreferrer">图片库</a>
        <a href="{{ '/feed.xml' | relative_url }}" class="nav-link" target="_blank" rel="noopener noreferrer">RSS 订阅</a>
        <a href="https://www.travellings.cn/go.html" class="nav-link" target="_blank" rel="noopener noreferrer" title="开往随机博客">友链接力</a>
      </div>
      
      <!-- 原图开关 -->
      <div class="theme-toggle">
        <label class="toggle-label">
          <span class="toggle-text">原图</span>
          <div class="toggle-switch">
            <input type="checkbox" id="originalImageToggle">
            <span class="toggle-slider"></span>
          </div>
        </label>
      </div>
      
      <!-- 深色模式切换 -->
      <div class="theme-toggle">
        <label class="toggle-label">
          <span class="toggle-text">深色模式</span>
          <div class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="toggle-slider"></span>
          </div>
        </label>
      </div>
      
      <!-- 版权信息 -->
      <div class="copyright">
        © {{ site.name | default: site.title }}
      </div>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="blog-main" id="blogMain">
    <!-- 文章列表视图 -->
    <div id="postsView">
      <!-- 过滤条件标题 -->
      <div id="filterHeader" class="filter-header" style="display: none;">
        <div class="filter-title-container">
          <h1 id="filterTitle" class="filter-title"></h1>
          <a href="#" id="backToHome" class="back-to-home">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            返回主页
          </a>
        </div>
      </div>
      <div id="postsContainer">
        {% for post in site.posts %}
        <article class="post-card" 
                 data-year="{{ post.date | date: '%Y' }}" 
                 data-tags="{{ post.tags | join: ',' }}" 
                 data-url="{{ post.url | relative_url }}"
                 data-post-index="{{ forloop.index0 }}">
          <a href="{{ post.url | relative_url }}" class="post-card-link">
            {% if post.image %}
            <div class="post-card-image">
              <img src="https://images.weserv.nl/?url={{ post.image | absolute_url | url_encode }}&w=400&h=200&output=jpg&q=80&fit=cover" alt="{{ post.title }}" loading="lazy">
            </div>
            {% endif %}
            <div class="post-card-content">
              <h2 class="post-card-title">{{ post.title }}</h2>
              <div class="post-card-meta">
                <span class="post-card-date">{{ post.date | date: "%Y-%m-%d" }}</span>
                {% if post.tags.size > 0 %}
                <span class="post-card-tags">
                  {% for tag in post.tags limit: 3 %}
                  <span class="post-tag">#{{ tag }}</span>
                  {% endfor %}
                </span>
                {% endif %}
              </div>
              {% if post.excerpt %}
              <p class="post-card-excerpt">{{ post.excerpt | strip_html | truncatewords: 30 }}</p>
              {% endif %}
            </div>
          </a>
        </article>
        {% endfor %}
      </div>
      
      <div id="loadingIndicator" class="loading" style="display: none;">
        正在加载更多文章...
      </div>
      
      <div id="noMorePosts" class="no-more" style="display: none;">
        没有更多文章了
      </div>
    </div>

    <!-- 文章/页面详情视图 -->
    <div id="postView" style="display: none;">
      <div class="post-detail-header">
        <button id="backToList" class="back-button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          返回主页
        </button>
      </div>
      
      <div id="postContent" class="post-detail-wrapper">
        <div class="loading">正在加载内容...</div>
      </div>
    </div>
    
    <!-- 返回顶部按钮 -->
    <button id="backToTopBtn" class="back-to-top-btn" style="display: none;" title="返回顶部">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 19V5M12 5L5 12M12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </main>
</div>

<!-- 移动端标题栏 -->
<div class="mobile-header">
  <div class="mobile-header-logo">
    <a href="{{ site.url }}">
      <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="logo-image">
    </a>
    <a href="{{ site.url }}" class="logo-text">{{ site.title }}</a>
  </div>
  <button class="hamburger-button" id="hamburgerButton" aria-label="打开菜单">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>
</div>

<!-- 移动端遮罩层 -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- 隐藏的文章数据 -->
<script id="postsData" type="application/json">
[
  {% for post in site.posts %}
  {
    "title": {{ post.title | jsonify }},
    "url": "{{ post.url | relative_url }}",
    "date": "{{ post.date | date: '%Y-%m-%d' }}",
    "author": "{{ post.author | default: site.author }}",
    "tags": {{ post.tags | jsonify }},
    "image": "{{ post.image | relative_url }}",
    "excerpt": {{ post.excerpt | strip_html | truncatewords: 30 | jsonify }},
    "year": "{{ post.date | date: '%Y' }}",
    "next": {% if post.next %}{"title": {{ post.next.title | jsonify }}, "url": "{{ post.next.url | relative_url }}"}{% else %}null{% endif %},
    "previous": {% if post.previous %}{"title": {{ post.previous.title | jsonify }}, "url": "{{ post.previous.url | relative_url }}"}{% else %}null{% endif %}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
]
</script>

<script>
// 全局变量
let allPosts = [];
let postsMetadata = [];
let filteredPosts = [];
let currentFilter = { type: null, value: null };
let displayedCount = 12;
const postsPerLoad = 12;
let currentPostIndex = -1;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing blog...');
  
  // 加载文章元数据
  loadPostsMetadata();
  
  // 收集所有文章数据
  collectAllPosts();
  
  // 生成标签词云
  generateTagCloud();
  
  // 绑定事件
  bindEvents();
  
  // 初始化无限滚动
  initInfiniteScroll();
  
  // 初始渲染
  renderPosts();
  
  // 检查URL参数和路径，自动加载对应内容
  checkAndLoadFromURL();
  
  console.log('Blog initialized with', allPosts.length, 'posts');
});

// 加载文章元数据
function loadPostsMetadata() {
  const dataScript = document.getElementById('postsData');
  if (dataScript) {
    postsMetadata = JSON.parse(dataScript.textContent);
    console.log('Loaded metadata for', postsMetadata.length, 'posts');
  }
}

// 收集所有文章数据
function collectAllPosts() {
  const postCards = document.querySelectorAll('.post-card');
  allPosts = [];
  
  postCards.forEach(card => {
    const tags = card.dataset.tags ? card.dataset.tags.split(',').filter(t => t) : [];
    const isAIGC = tags.includes('AIGC');
    
    // 在DOM层面隐藏AIGC文章
    if (isAIGC) {
      card.style.display = 'none';
    } else {
      allPosts.push({
        element: card,
        year: card.dataset.year,
        tags: tags,
        title: card.querySelector('.post-card-title').textContent.toLowerCase(),
        excerpt: card.querySelector('.post-card-excerpt')?.textContent.toLowerCase() || '',
        url: card.dataset.url,
        index: parseInt(card.dataset.postIndex)
      });
    }
  });
  
  filteredPosts = [...allPosts];
}

// 生成标签词云（大小写不敏感去重）
function generateTagCloud() {
  const tagsContainer = document.getElementById('tagsContainer');
  if (!tagsContainer) return;
  
  // 收集所有标签
  const tagMap = new Map(); // 使用 Map 来存储小写标签到原始标签的映射
  
  allPosts.forEach(post => {
    post.tags.forEach(tag => {
      const lowerTag = tag.toLowerCase();
      // 如果这个小写标签还没有，或者当前标签是大写开头，则使用当前标签
      if (!tagMap.has(lowerTag) || (tag[0] === tag[0].toUpperCase() && tagMap.get(lowerTag)[0] === tagMap.get(lowerTag)[0].toLowerCase())) {
        tagMap.set(lowerTag, tag);
      }
    });
  });
  
  // 按字母顺序排序
  const sortedTags = Array.from(tagMap.values()).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  
  // 生成标签按钮
  tagsContainer.innerHTML = '';
  sortedTags.forEach(tag => {
    const tagBtn = document.createElement('a');
    tagBtn.href = `/?tag=${encodeURIComponent(tag)}`;
    tagBtn.className = 'tag-btn';
    tagBtn.dataset.tag = tag;
    tagBtn.textContent = tag;
    tagBtn.addEventListener('click', (e) => {
      e.preventDefault();
      handleTagClick(tag, tagBtn);
    });
    tagsContainer.appendChild(tagBtn);
  });
}

// 绑定事件
function bindEvents() {
  // 搜索
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(handleSearch, 300));
  }
  
  // AIGC早报链接
  const aigcLink = document.querySelector('.aigc-link');
  if (aigcLink) {
    aigcLink.addEventListener('click', (e) => {
      e.preventDefault();
      const tag = aigcLink.dataset.tag;
      
      // 如果当前在文章页，先返回列表
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        showPostsList();
      }
      
      handleAIGCClick(tag);
    });
  }
  
  // 原图开关
  const originalImageToggle = document.getElementById('originalImageToggle');
  if (originalImageToggle) {
    originalImageToggle.addEventListener('change', () => {
      localStorage.setItem('useOriginalImage', originalImageToggle.checked);
      // 如果当前在文章详情页，重新渲染图片
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        reloadPostImages();
      }
    });
    
    // 恢复保存的状态
    const savedState = localStorage.getItem('useOriginalImage');
    if (savedState !== null) {
      originalImageToggle.checked = savedState === 'true';
    }
  }
  
  // 标签点击
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const tag = e.target.dataset.tag;
      
      // 如果当前在文章页，先返回列表
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        showPostsList();
      }
      
      handleTagClick(tag, e.target);
    });
  });
  
  // 年份链接点击
  document.querySelectorAll('.year-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const year = e.target.dataset.year;
      
      // 如果当前在文章页，先返回列表
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        showPostsList();
      }
      
      handleYearClick(year);
    });
  });
  
  // 导航链接点击（about等页面）
  document.querySelectorAll('.nav-link[data-page-url]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const url = e.target.dataset.pageUrl;
      loadPageContent(url, e.target.textContent);
    });
  });
  
  // 文章卡片点击
  document.addEventListener('click', (e) => {
    const postLink = e.target.closest('.post-card-link');
    if (postLink) {
      e.preventDefault();
      const postCard = postLink.closest('.post-card');
      const postIndex = parseInt(postCard.dataset.postIndex);
      loadPostContent(postIndex);
    }
  });
  
  // 返回列表按钮
  const backToList = document.getElementById('backToList');
  if (backToList) {
    backToList.addEventListener('click', showPostsList);
  }
  
  // 返回主页按钮
  const backToHome = document.getElementById('backToHome');
  if (backToHome) {
    backToHome.addEventListener('click', (e) => {
      e.preventDefault();
      resetToHome();
    });
  }
  
  // 移动端菜单
  const hamburgerButton = document.getElementById('hamburgerButton');
  if (hamburgerButton) {
    hamburgerButton.addEventListener('click', toggleMobileSidebar);
  }
  
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', closeMobileSidebar);
  }
  
  // 返回顶部按钮
  const backToTopBtn = document.getElementById('backToTopBtn');
  if (backToTopBtn) {
    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  
  // 监听滚动，显示/隐藏返回顶部按钮
  window.addEventListener('scroll', () => {
    if (backToTopBtn) {
      if (window.scrollY > 300) {
        backToTopBtn.style.display = 'flex';
      } else {
        backToTopBtn.style.display = 'none';
      }
    }
  });
}

// 搜索处理
function handleSearch(e) {
  const query = e.target.value.toLowerCase().trim();
  
  // 如果当前在文章页，先返回列表
  const postView = document.getElementById('postView');
  if (postView && postView.style.display !== 'none') {
    showPostsList();
  }
  
  if (query === '') {
    if (currentFilter.type) {
      applyFilter(currentFilter.type, currentFilter.value);
    } else {
      filteredPosts = [...allPosts];
      displayedCount = 12;
      renderPosts();
    }
    return;
  }
  
  currentFilter = { type: 'search', value: query };
  filteredPosts = allPosts.filter(post => 
    post.title.includes(query) || post.excerpt.includes(query)
  );
  
  displayedCount = Math.min(12, filteredPosts.length);
  updateFilterHeader('search', query);
  renderPosts();
  
  // 清除标签高亮
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
  
  // 更新浏览器历史 - 使用主页路径
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('search', query);
  updatePageTitle('search', query);
  window.history.pushState({ 
    type: 'search', 
    value: query,
    listScrollPos: 0
  }, getPageTitle('search', query), url);
  closeMobileSidebar();
}

// 标签点击处理
function handleTagClick(tag, element) {
  // 如果当前在文章页或页面视图，先返回列表
  const postView = document.getElementById('postView');
  const pageView = document.getElementById('pageView');
  if (postView && postView.style.display !== 'none') {
    showPostsList();
  }
  if (pageView && pageView.style.display !== 'none') {
    showPostsList();
  }
  
  const wasActive = element.classList.contains('active');
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  if (wasActive) {
    currentFilter = { type: null, value: null };
    filteredPosts = [...allPosts];
    displayedCount = 12;
    updateFilterHeader(null, null);
    
    // 返回主页，清除URL参数
    updatePageTitle(null, null);
    window.history.pushState({ type: null }, getPageTitle(null, null), '/');
  } else {
    element.classList.add('active');
    currentFilter = { type: 'tag', value: tag };
    // 标签匹配时忽略大小写
    filteredPosts = allPosts.filter(post => 
      post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
    );
    displayedCount = Math.min(12, filteredPosts.length);
    updateFilterHeader('tag', tag);
    
    // 更新浏览器历史 - 使用主页路径
    const url = new URL(window.location.origin + '/');
    url.searchParams.set('tag', tag);
    updatePageTitle('tag', tag);
    window.history.pushState({ 
      type: 'tag', 
      value: tag,
      listScrollPos: 0
    }, getPageTitle('tag', tag), url);
  }
  
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  renderPosts();
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
  
  closeMobileSidebar();
}

// 年份点击处理
function handleYearClick(year) {
  // 如果当前在文章页或页面视图，先返回列表
  const postView = document.getElementById('postView');
  const pageView = document.getElementById('pageView');
  if (postView && postView.style.display !== 'none') {
    showPostsList();
  }
  if (pageView && pageView.style.display !== 'none') {
    showPostsList();
  }
  
  currentFilter = { type: 'year', value: year };
  filteredPosts = allPosts.filter(post => post.year === year);
  displayedCount = Math.min(12, filteredPosts.length);
  updateFilterHeader('year', year);
  
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  renderPosts();
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
  
  // 更新浏览器历史 - 使用主页路径
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('year', year);
  updatePageTitle('year', year);
  window.history.pushState({ 
    type: 'year', 
    value: year,
    listScrollPos: 0
  }, getPageTitle('year', year), url);
  closeMobileSidebar();
}

// 从文章页点击标签的处理
function handleTagClickFromPost(tag) {
  // 关闭文章详情页，返回列表
  showPostsList();
  
  // 应用标签筛选
  currentFilter = { type: 'tag', value: tag };
  // 标签匹配时忽略大小写
  filteredPosts = allPosts.filter(post => 
    post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
  );
  displayedCount = Math.min(12, filteredPosts.length);
  
  // 清空搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
    // 高亮对应的标签按钮
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tag === tag) {
      btn.classList.add('active');
    }
  });
  
  // 更新过滤标题
  updateFilterHeader('tag', tag);
  
  // 更新URL和标题
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('tag', tag);
  updatePageTitle('tag', tag);
  const blogMain = document.getElementById('blogMain');
  window.history.pushState({ 
    type: 'tag', 
    value: tag,
    listScrollPos: blogMain ? blogMain.scrollTop : 0
  }, getPageTitle('tag', tag), url);
  
  renderPosts();
  closeMobileSidebar();
}

// 渲染文章列表
function renderPosts() {
  // 隐藏所有文章卡片（包括AIGC文章）
  const allPostCards = document.querySelectorAll('.post-card');
  allPostCards.forEach(card => {
    card.style.display = 'none';
  });
  
  // 显示当前筛选的文章
  const postsToShow = filteredPosts.slice(0, displayedCount);
  postsToShow.forEach(post => {
    post.element.style.display = 'block';
  });
  
  const noMorePosts = document.getElementById('noMorePosts');
  if (displayedCount >= filteredPosts.length) {
    noMorePosts.style.display = filteredPosts.length === 0 ? 'none' : 'block';
  } else {
    noMorePosts.style.display = 'none';
  }
}

// 无限滚动
function initInfiniteScroll() {
  const blogMain = document.getElementById('blogMain');
  
  blogMain.addEventListener('scroll', () => {
    const postsView = document.getElementById('postsView');
    if (postsView.style.display === 'none') return;
    
    const scrollTop = blogMain.scrollTop;
    const scrollHeight = blogMain.scrollHeight;
    const clientHeight = blogMain.clientHeight;
    
    if (scrollHeight - scrollTop - clientHeight < 200) {
      loadMorePosts();
    }
  });
}

// 加载更多文章
let isLoading = false;
function loadMorePosts() {
  if (isLoading || displayedCount >= filteredPosts.length) return;
  
  isLoading = true;
  const loadingIndicator = document.getElementById('loadingIndicator');
  loadingIndicator.style.display = 'block';
  
  setTimeout(() => {
    displayedCount = Math.min(displayedCount + postsPerLoad, filteredPosts.length);
    renderPosts();
    loadingIndicator.style.display = 'none';
    isLoading = false;
  }, 300);
}

// 加载页面内容（about等静态页面）
async function loadPageContent(url, title) {
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const postContent = document.getElementById('postContent');
  const blogMain = document.getElementById('blogMain');
  
  // 切换视图
  postsView.style.display = 'none';
  postView.style.display = 'block';
  blogMain.scrollTop = 0;
  
  // 更新浏览器URL和标题
  window.history.pushState(
    { type: 'page', url: url, title: title },
    title,
    url
  );
  updatePageTitle('page', title);
  
  // 显示加载状态
  postContent.innerHTML = '<div class="loading">正在加载内容...</div>';
  
  try {
    const response = await fetch(url);
    const html = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 提取页面内容
    const article = doc.querySelector('article') || doc.querySelector('.prose') || doc.querySelector('main');
    
    if (article) {
      renderPageDetail(title, url, article.innerHTML);
    } else {
      postContent.innerHTML = '<div class="error">无法加载页面内容</div>';
    }
    
    closeMobileSidebar();
  } catch (error) {
    console.error('Failed to load page:', error);
    postContent.innerHTML = '<div class="error">加载失败，请刷新重试</div>';
  }
}

// 渲染页面详情
function renderPageDetail(title, url, content) {
  const postContent = document.getElementById('postContent');
  
  let html = '<div class="post-detail-container">';
  
  // 页面头部
  html += '<div class="post-detail-head">';
  html += `<h1 class="post-detail-title">${title}</h1>`;
  html += '</div>';
  
  // 页面内容
  html += `<div class="post-detail-article">${content}</div>`;
  
  // 分享按钮
  html += renderShareButtons({title: title, url: url});
  
  // 评论系统
  html += renderCommentSystem(url);
  
  html += '</div>';
  
  postContent.innerHTML = html;
}

// 加载文章内容
async function loadPostContent(postIndex) {
  currentPostIndex = postIndex;
  const post = postsMetadata[postIndex];
  
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const postContent = document.getElementById('postContent');
  const blogMain = document.getElementById('blogMain');
  
  // 先保存当前滚动位置和筛选状态（在切换视图之前）
  const scrollPos = window.scrollY || document.documentElement.scrollTop;
  const listScrollPos = blogMain.scrollTop;
  
  // 切换视图
  postsView.style.display = 'none';
  postView.style.display = 'block';
  blogMain.scrollTop = 0;
  
  // 更新浏览器URL和标题
  window.history.pushState(
    { 
      type: 'post', 
      postIndex: postIndex, 
      scrollPos: scrollPos,
      listScrollPos: listScrollPos,
      filter: currentFilter
    },
    post.title,
    post.url
  );
  updatePageTitle('post', post.title);
  
  // 显示加载状态
  postContent.innerHTML = '<div class="loading">正在加载文章...</div>';
  
  try {
    // 获取文章内容
    const response = await fetch(post.url);
    const html = await response.text();
    
    // 解析HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 提取文章内容
    const article = doc.querySelector('article') || doc.querySelector('.prose');
    
    if (article) {
      // 移除文章中的标题和题图（因为renderPostDetail会添加）
      const articleClone = article.cloneNode(true);
      
      // 移除h1标题
      const h1 = articleClone.querySelector('h1');
      if (h1) h1.remove();
      
      // 移除题图（通常是第一个img或包含img的第一个div）
      const firstImg = articleClone.querySelector('img');
      if (firstImg) {
        // 如果img在div中，移除整个div
        const imgParent = firstImg.parentElement;
        if (imgParent && imgParent.tagName === 'DIV' && imgParent.children.length === 1) {
          imgParent.remove();
        } else {
          firstImg.remove();
        }
      }
      
      // 构建完整的文章详情页
      renderPostDetail(post, articleClone.innerHTML);
    } else {
      postContent.innerHTML = '<div class="error">无法加载文章内容</div>';
    }
  } catch (error) {
    console.error('Failed to load post:', error);
    postContent.innerHTML = '<div class="error">加载失败，请刷新重试</div>';
  }
}

// 处理文章中的图片
function processArticleImages(html) {
  const useOriginal = document.getElementById('originalImageToggle')?.checked || false;
  if (useOriginal) {
    return html; // 原图模式，不处理
  }
  
  // 使用正则替换所有img标签的src
  return html.replace(/<img([^>]+)src=["']([^"']+)["']([^>]*)>/gi, (match, before, src, after) => {
    // 如果已经是weserv链接，不再处理
    if (src.includes('weserv.nl')) {
      return match;
    }
    
    // 如果是相对路径，转为绝对路径
    let absoluteSrc = src;
    if (src.startsWith('/')) {
      absoluteSrc = window.location.origin + src;
    } else if (!src.startsWith('http')) {
      absoluteSrc = window.location.origin + '/' + src;
    }
    
    const weservUrl = `https://images.weserv.nl/?url=${encodeURIComponent(absoluteSrc)}&output=jpg&q=80`;
    return `<img${before}src="${weservUrl}" data-original="${src}"${after}>`;
  });
}

// 重新加载文章中的图片
function reloadPostImages() {
  const postDetailArticle = document.querySelector('.post-detail-article');
  const postDetailImage = document.querySelector('.post-detail-image img');
  const useOriginal = document.getElementById('originalImageToggle')?.checked || false;
  
  // 重新加载题图
  if (postDetailImage && postDetailImage.dataset.original) {
    const originalSrc = postDetailImage.dataset.original;
    postDetailImage.src = useOriginal ? originalSrc : `https://images.weserv.nl/?url=${encodeURIComponent(originalSrc)}&output=jpg&q=80`;
  }
  
  // 重新加载文章中的图片
  if (postDetailArticle) {
    const images = postDetailArticle.querySelectorAll('img[data-original]');
    images.forEach(img => {
      const originalSrc = img.dataset.original;
      if (useOriginal) {
        img.src = originalSrc;
      } else {
        let absoluteSrc = originalSrc;
        if (originalSrc.startsWith('/')) {
          absoluteSrc = window.location.origin + originalSrc;
        } else if (!originalSrc.startsWith('http')) {
          absoluteSrc = window.location.origin + '/' + originalSrc;
        }
        img.src = `https://images.weserv.nl/?url=${encodeURIComponent(absoluteSrc)}&output=jpg&q=80`;
      }
    });
  }
}

// AIGC早报点击处理
function handleAIGCClick(tag) {
  // 重置其他筛选
  currentFilter = { type: 'tag', value: tag };
  
  // 收集所有文章（包括AIGC）
  const postCards = document.querySelectorAll('.post-card');
  const allPostsIncludingAIGC = Array.from(postCards).map(card => ({
    element: card,
    year: card.dataset.year,
    tags: card.dataset.tags ? card.dataset.tags.split(',').filter(t => t) : [],
    title: card.querySelector('.post-card-title').textContent.toLowerCase(),
    excerpt: card.querySelector('.post-card-excerpt')?.textContent.toLowerCase() || '',
    url: card.dataset.url,
    index: parseInt(card.dataset.postIndex)
  }));
  
  // 筛选AIGC标签的文章（忽略大小写）
  filteredPosts = allPostsIncludingAIGC.filter(post => 
    post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
  );
  displayedCount = Math.min(12, filteredPosts.length);
  
  // 清空搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  // 取消所有标签高亮
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  updateFilterHeader('tag', tag);
  renderPosts();
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
  
  closeMobileSidebar();
  
  // 更新浏览器历史
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('tag', tag);
  updatePageTitle('tag', tag);
  window.history.pushState({ 
    type: 'tag', 
    value: tag,
    listScrollPos: 0
  }, getPageTitle('tag', tag), url);
}

// 渲染文章详情
function renderPostDetail(post, articleContent) {
  const postContent = document.getElementById('postContent');
  
  let html = '<div class="post-detail-container">';
  
  // 文章头部
  html += '<div class="post-detail-head">';
  html += `<h1 class="post-detail-title">${post.title}</h1>`;
  html += '<div class="post-detail-meta">';
  html += `<span class="post-detail-author">${post.author}</span>`;
  html += `<span class="post-detail-date">${post.date}</span>`;
  html += '</div>';
  
  // 标签
  if (post.tags && post.tags.length > 0) {
    html += '<div class="post-detail-tags">';
    post.tags.forEach(tag => {
      html += `<a href="#" class="post-detail-tag" data-tag="${tag}" onclick="event.preventDefault(); handleTagClickFromPost('${tag}')">#${tag}</a>`;
    });
    html += '</div>';
  }
  html += '</div>';
  
  // 题图
  if (post.image && post.image !== '/') {
    const useOriginal = document.getElementById('originalImageToggle')?.checked || false;
    const imageUrl = useOriginal ? post.image : `https://images.weserv.nl/?url=${encodeURIComponent(post.image)}&output=jpg&q=80`;
    html += `<div class="post-detail-image"><img src="${imageUrl}" alt="${post.title}" data-original="${post.image}"></div>`;
  }
  
  // 文章内容（处理图片）
  const processedContent = processArticleImages(articleContent);
  html += `<div class="post-detail-article">${processedContent}</div>`;
  
  // 分享按钮
  html += renderShareButtons(post);
  
  // 上一篇/下一篇导航
  html += renderPostNavigation(post);
  
  // 评论系统
  html += renderCommentSystem(post.url);
  
  html += '</div>';
  
  postContent.innerHTML = html;
}

// 渲染分享按钮
function renderShareButtons(post) {
  const url = encodeURIComponent(window.location.origin + post.url);
  const title = encodeURIComponent(post.title);
  
  let html = '<div class="share-buttons">';
  html += '<div class="share-label">分享到：</div>';
  html += '<div class="share-buttons-container">';
  
  // 微博
  html += `<a href="https://service.weibo.com/share/share.php?url=${url}&title=${title}" target="_blank" rel="noopener noreferrer" class="share-btn share-weibo" title="分享到微博">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.194 14.197c-.402 1.092-1.634 1.594-2.761 1.123-1.126-.471-1.535-1.797-1.133-2.889.403-1.092 1.634-1.594 2.761-1.123 1.126.471 1.535 1.797 1.133 2.889zm-4.402-2.107c-.201.546-.817.797-1.381.562-.563-.235-.768-.898-.567-1.444.201-.546.817-.797 1.381-.562.563.235.768.898.567 1.444zm7.208 1.91c0 4.418-5.373 8-12 8s-12-3.582-12-8c0-1.5.568-2.898 1.548-4.129C2.537 7.697 4.179 6 6.545 6c1.635 0 3.087.691 4.091 1.772.904-.447 1.906-.697 2.955-.697 3.866 0 7 2.686 7 6 0 .343-.034.68-.1 1.009.668.542 1.109 1.346 1.109 2.241z"/></svg>
    微博
  </a>`;
  
  // Twitter
  html += `<a href="https://twitter.com/intent/tweet?url=${url}&text=${title}" target="_blank" rel="noopener noreferrer" class="share-btn share-twitter" title="分享到Twitter">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
    Twitter
  </a>`;
  
  // Facebook
  html += `<a href="https://www.facebook.com/sharer/sharer.php?u=${url}" target="_blank" rel="noopener noreferrer" class="share-btn share-facebook" title="分享到Facebook">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
    Facebook
  </a>`;
  
  // 微信
  html += `<button class="share-btn share-wechat" onclick="alert('请使用微信扫一扫分享')" title="分享到微信">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-5.523 3.317-6.523 1.961-.62 3.756-.31 5.164.403.278-3.701-3.315-6.512-8.292-6.512zm-2.43 4.645a.97.97 0 0 1 .972.972.97.97 0 0 1-.972.972.97.97 0 0 1-.972-.972.97.97 0 0 1 .972-.972zm5.641 0a.97.97 0 0 1 .972.972.97.97 0 0 1-.972.972.97.97 0 0 1-.972-.972.97.97 0 0 1 .972-.972z"/><path d="M15.314 9.403c-3.707 0-6.713 2.462-6.713 5.5 0 1.665.927 3.156 2.383 4.167.091.063.156.15.169.25l-.296 1.11c-.015.053-.038.107-.038.161 0 .122.098.223.218.223a.25.25 0 0 0 .126-.041l1.427-.834a.65.65 0 0 1 .538-.074c.584.16 1.201.241 1.834.241 3.707 0 6.713-2.462 6.713-5.5s-3.006-5.5-6.713-5.5zm-1.834 3.444a.73.73 0 0 1 .731.731.73.73 0 0 1-.731.731.73.73 0 0 1-.731-.731.73.73 0 0 1 .731-.731zm3.669 0a.73.73 0 0 1 .731.731.73.73 0 0 1-.731.731.73.73 0 0 1-.731-.731.73.73 0 0 1 .731-.731z"/></svg>
    微信
  </button>`;
  
  // 复制链接
  html += `<button class="share-btn share-copy" onclick="copyPostLink('${post.url}')" title="复制链接">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    复制链接
  </button>`;
  
  html += '</div></div>';
  
  return html;
}

// 复制链接函数
function copyPostLink(url) {
  const fullUrl = window.location.origin + url;
  navigator.clipboard.writeText(fullUrl).then(() => {
    alert('链接已复制到剪贴板');
  }).catch(() => {
    alert('复制失败，请手动复制：' + fullUrl);
  });
}

// 渲染文章导航
function renderPostNavigation(post) {
  let html = '<div class="post-navigation">';
  
  if (post.previous) {
    html += `<a href="#" class="post-nav-link post-nav-prev" onclick="event.preventDefault(); loadPostByUrl('${post.previous.url}')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.1795 3.26875C15.7889 2.87823 15.1558 2.87823 14.7652 3.26875L8.12078 9.91322C6.94952 11.0845 6.94916 12.9833 8.11996 14.155L14.6903 20.7304C15.0808 21.121 15.714 21.121 16.1045 20.7304C16.495 20.3399 16.495 19.7067 16.1045 19.3162L9.53246 12.7442C9.14194 12.3536 9.14194 11.7205 9.53246 11.33L16.1795 4.68297C16.57 4.29244 16.57 3.65928 16.1795 3.26875Z"></path></svg>
      <span>${post.previous.title}</span>
    </a>`;
  }
  
  if (post.next) {
    html += `<a href="#" class="post-nav-link post-nav-next" onclick="event.preventDefault(); loadPostByUrl('${post.next.url}')">
      <span>${post.next.title}</span>
      <svg viewBox="0 0 24 24" fill="currentColor" transform="rotate(180)"><path d="M16.1795 3.26875C15.7889 2.87823 15.1558 2.87823 14.7652 3.26875L8.12078 9.91322C6.94952 11.0845 6.94916 12.9833 8.11996 14.155L14.6903 20.7304C15.0808 21.121 15.714 21.121 16.1045 20.7304C16.495 20.3399 16.495 19.7067 16.1045 19.3162L9.53246 12.7442C9.14194 12.3536 9.14194 11.7205 9.53246 11.33L16.1795 4.68297C16.57 4.29244 16.57 3.65928 16.1795 3.26875Z"></path></svg>
    </a>`;
  }
  
  html += '</div>';
  
  return html;
}

// 通过URL加载文章
function loadPostByUrl(url) {
  const index = postsMetadata.findIndex(p => p.url === url);
  if (index !== -1) {
    loadPostContent(index);
  }
}

// 渲染评论系统
function renderCommentSystem(pathname) {
  let html = '<div class="comments-section">';
  html += '<h3 class="comments-title">评论</h3>';
  html += '<div class="giscus-container"></div>';
  html += '</div>';
  
  // 延迟加载giscus
  setTimeout(() => {
    loadGiscus(pathname);
  }, 500);
  
  return html;
}

// 加载giscus评论系统
function loadGiscus(pathname) {
  const container = document.querySelector('.giscus-container');
  if (!container) return;
  
  // 清空容器
  container.innerHTML = '';
  
  // 创建script标签
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'lishuhang/lishuhang.github.io');
  script.setAttribute('data-repo-id', 'R_kgDOKbcVHw');
  script.setAttribute('data-category', 'Announcements');
  script.setAttribute('data-category-id', 'DIC_kwDOKbcVH84CwoJY');
  script.setAttribute('data-mapping', 'specific');
  script.setAttribute('data-term', pathname);
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'preferred_color_scheme');
  script.setAttribute('data-lang', 'zh-CN');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  
  container.appendChild(script);
}

// 显示文章列表
function showPostsList(restoreScroll = false) {
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const blogMain = document.getElementById('blogMain');
  
  postView.style.display = 'none';
  postsView.style.display = 'block';
  
  // 恢复滚动位置或滚动到顶部
  if (!restoreScroll) {
    blogMain.scrollTop = 0;
    window.scrollTo(0, 0);
  }
  
  currentPostIndex = -1;
  
  // 更新URL为当前筛选状态（仅在非恢复模式下）
  if (!restoreScroll) {
    if (currentFilter.type) {
      const url = new URL(window.location.origin + '/');
      url.searchParams.set(currentFilter.type, currentFilter.value);
      let title = '';
      if (currentFilter.type === 'year') {
        title = `${currentFilter.value}年文章`;
      } else if (currentFilter.type === 'tag') {
        title = `标签：${currentFilter.value}`;
      } else if (currentFilter.type === 'search') {
        title = `搜索：${currentFilter.value}`;
      }
      window.history.pushState(
        { 
          type: currentFilter.type, 
          value: currentFilter.value,
          listScrollPos: blogMain ? blogMain.scrollTop : 0
        },
        title,
        url
      );
        updatePageTitle(currentFilter.type, currentFilter.value);
      } else {
        updatePageTitle(null, null);
        window.history.pushState({ 
          type: null,
          listScrollPos: blogMain ? blogMain.scrollTop : 0
        }, getPageTitle(null, null), '/');
    }
  }
}

// 移动端侧边栏控制
function toggleMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
  document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
}

function closeMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 检查URL并加载对应内容
function checkAndLoadFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  const pathname = window.location.pathname;
  
  // 检查是否有post参数（从page.html重定向而来）
  if (urlParams.has('post')) {
    const postUrl = urlParams.get('post');
    const postIndex = postsMetadata.findIndex(post => post.url === postUrl);
    if (postIndex !== -1) {
      console.log('Loading post from redirect:', postUrl);
      loadPostContent(postIndex);
      // 更新URL为文章的真实URL，移除post参数
      window.history.replaceState(
        { type: 'post', postIndex: postIndex },
        postsMetadata[postIndex].title,
        postUrl
      );
      return;
    }
  }
  
  // 检查是否是文章URL (e.g., /posts/2025/07/23/daily/)
  if (pathname.startsWith('/posts/') && pathname !== '/posts/') {
    // 查找匹配的文章
    const postIndex = postsMetadata.findIndex(post => post.url === pathname);
    if (postIndex !== -1) {
      console.log('Loading post from URL:', pathname);
      loadPostContent(postIndex);
      return;
    }
  }
  
  // 检查URL参数
  if (urlParams.has('tag')) {
    const tag = urlParams.get('tag');
    // 先尝试精确匹配
    let tagBtn = document.querySelector(`.tag-btn[data-tag="${tag}"]`);
    // 如果没有找到，尝试大小写不敏感匹配
    if (!tagBtn) {
      const allTagBtns = document.querySelectorAll('.tag-btn');
      tagBtn = Array.from(allTagBtns).find(btn => 
        btn.dataset.tag.toLowerCase() === tag.toLowerCase()
      );
    }
    if (tagBtn) {
      tagBtn.click();
    } else if (tag.toLowerCase() === 'aigc') {
      // 如果是 AIGC 标签，直接调用 handleAIGCClick
      handleAIGCClick(tag);
    }
  } else if (urlParams.has('year')) {
    const year = urlParams.get('year');
    handleYearClick(year);
  } else if (urlParams.has('search')) {
    const query = urlParams.get('search');
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.value = query;
      handleSearch({ target: searchInput });
    }
  }
}

// 更新过滤条件标题
function updateFilterHeader(type, value) {
  const filterHeader = document.getElementById('filterHeader');
  const filterTitle = document.getElementById('filterTitle');
  
  if (!type || !value) {
    filterHeader.style.display = 'none';
    return;
  }
  
  let title = '';
  if (type === 'year') {
    title = `${value}年文章`;
  } else if (type === 'tag') {
    title = `标签：${value}`;
  } else if (type === 'search') {
    title = `搜索：${value}`;
  }
  
  filterTitle.textContent = title;
  filterHeader.style.display = 'block';
}

// 获取页面标题
function getPageTitle(type, value) {
  const siteTitle = '{{ site.title }}';
  const siteTagline = '{{ site.tagline | default: "你应该知道的历史、现在和未来" }}';
  
  if (!type || !value) {
    return `${siteTitle} | ${siteTagline}`;
  }
  
  let prefix = '';
  if (type === 'year') {
    prefix = `${value}年文章`;
  } else if (type === 'tag') {
    prefix = `标签：${value}`;
  } else if (type === 'search') {
    prefix = `搜索：${value}`;
  } else if (type === 'post') {
    return `${value} - ${siteTitle}`;
  } else if (type === 'page') {
    return `${value} - ${siteTitle}`;
  }
  
  return `${prefix} - ${siteTitle}`;
}

// 更新页面标题
function updatePageTitle(type, value) {
  document.title = getPageTitle(type, value);
}

// 返回主页
function resetToHome() {
  // 如果当前在文章页或页面视图，先返回列表
  const postView = document.getElementById('postView');
  const pageView = document.getElementById('pageView');
  if (postView && postView.style.display !== 'none') {
    showPostsList();
  }
  if (pageView && pageView.style.display !== 'none') {
    showPostsList();
  }
  
  // 清除所有筛选
  currentFilter = { type: null, value: null };
  filteredPosts = [...allPosts];
  displayedCount = 12;
  
  // 清除搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  // 清除标签高亮
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  // 隐藏过滤标题
  updateFilterHeader(null, null);
  
  // 重新渲染列表
  renderPosts();
  
  // 更新URL和标题
  updatePageTitle(null, null);
  window.history.pushState({ type: null }, getPageTitle(null, null), '/');
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
  
  // 关闭移动端侧边栏
  closeMobileSidebar();
}

// 处理浏览器前进后退
window.addEventListener('popstate', (event) => {
  if (event.state) {
    if (event.state.type === 'post') {
      // 加载文章
      loadPostContent(event.state.postIndex);
    } else if (event.state.type === 'tag') {
      // 应用标签筛选
      const tagBtn = document.querySelector(`.tag-btn[data-tag="${event.state.value}"]`);
      if (tagBtn) {
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
        tagBtn.classList.add('active');
      }
      currentFilter = { type: 'tag', value: event.state.value };
      // 标签匹配时忽略大小写
      filteredPosts = allPosts.filter(post => 
        post.tags.some(tag => tag.toLowerCase() === event.state.value.toLowerCase())
      );
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('tag', event.state.value);
      renderPosts();
      showPostsList(true);
      updatePageTitle('tag', event.state.value);
      // 恢复滚动位置
      if (event.state.listScrollPos !== undefined) {
        setTimeout(() => {
          const blogMain = document.getElementById('blogMain');
          blogMain.scrollTop = event.state.listScrollPos;
        }, 50);
      }
    } else if (event.state.type === 'year') {
      // 应用年份筛选
      currentFilter = { type: 'year', value: event.state.value };
      filteredPosts = allPosts.filter(post => post.year === event.state.value);
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('year', event.state.value);
      renderPosts();
      showPostsList(true);
      updatePageTitle('year', event.state.value);
      // 恢复滚动位置
      if (event.state.listScrollPos !== undefined) {
        setTimeout(() => {
          const blogMain = document.getElementById('blogMain');
          blogMain.scrollTop = event.state.listScrollPos;
        }, 50);
      }
    } else if (event.state.type === 'search') {
      // 应用搜索
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = event.state.value;
      currentFilter = { type: 'search', value: event.state.value };
      const searchQuery = event.state.value.toLowerCase();
      filteredPosts = allPosts.filter(post => 
        post.title.includes(searchQuery) || 
        post.excerpt.includes(searchQuery)
      );
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('search', event.state.value);
      renderPosts();
      showPostsList(true);
      updatePageTitle('search', event.state.value);
      // 恢复滚动位置
      if (event.state.listScrollPos !== undefined) {
        setTimeout(() => {
          const blogMain = document.getElementById('blogMain');
          blogMain.scrollTop = event.state.listScrollPos;
        }, 50);
      }
    } else if (event.state.type === 'page') {
      // 加载静态页面
      loadPageContent(event.state.url, event.state.title);
    } else {
      // 返回主页
      resetToHome();
    }
  } else {
    // 没有state，返回主页
    resetToHome();
  }
});

// 页面初始加载时设置初始状态
window.addEventListener('load', () => {
  // 设置初始状态
  window.history.replaceState({ type: null }, document.title, window.location.pathname + window.location.search);
});

// ===== 深色模式功能 =====

// 初始化深色模式
function initDarkMode() {
  const darkModeToggle = document.getElementById('darkModeToggle');
  if (!darkModeToggle) return;
  
  // 检查用户之前的选择
  const savedTheme = localStorage.getItem('theme');
  
  if (savedTheme) {
    // 如果用户之前选择过，使用保存的设置
    applyTheme(savedTheme);
    darkModeToggle.checked = savedTheme === 'dark';
  } else {
    // 否则跟随系统设置
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = prefersDark ? 'dark' : 'light';
    applyTheme(theme);
    darkModeToggle.checked = prefersDark;
  }
  
  // 监听切换按钮
  darkModeToggle.addEventListener('change', (e) => {
    const theme = e.target.checked ? 'dark' : 'light';
    applyTheme(theme);
    localStorage.setItem('theme', theme);
  });
  
  // 监听系统主题变化（仅当用户未手动设置时）
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      const theme = e.matches ? 'dark' : 'light';
      applyTheme(theme);
      darkModeToggle.checked = e.matches;
    }
  });
}

// 应用主题
function applyTheme(theme) {
  // 同时设置html和body的data-theme属性
  document.documentElement.setAttribute('data-theme', theme);
  document.body.setAttribute('data-theme', theme);
  
  // 更新 giscus 评论系统主题
  const giscusFrame = document.querySelector('iframe.giscus-frame');
  if (giscusFrame) {
    const giscusTheme = theme === 'dark' ? 'dark' : 'light';
    giscusFrame.contentWindow.postMessage(
      { giscus: { setConfig: { theme: giscusTheme } } },
      'https://giscus.app'
    );
  }
}

// 在 DOM 加载完成后初始化深色模式
document.addEventListener('DOMContentLoaded', initDarkMode);
</script>

