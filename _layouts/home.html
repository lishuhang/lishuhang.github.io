---
layout: base
---

<div class="blog-container">
  <!-- 侧边栏 -->
  <aside class="blog-sidebar" id="blogSidebar">
    <div class="blog-sidebar-header">
      <a href="{{ site.url }}" class="sidebar-logo-link">
        <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="sidebar-logo-image">
      </a>
      <a href="{{ site.url }}" class="blog-sidebar-title">{{ site.title }}</a>
    </div>
    
    <div class="blog-sidebar-body">
      <!-- 搜索框 -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索文章..." class="search-input">
      </div>
      
      <!-- 标签区域 -->
      <div class="tags-section">
        <label class="section-label">标签</label>
        <div class="tags-container" id="tagsContainer">
          {% assign all_tags = site.posts | map: 'tags' | join: ',' | split: ',' | uniq | sort %}
          {% for tag in all_tags %}
            {% if tag != "" %}
            <a href="#" class="tag-btn" data-tag="{{ tag }}">{{ tag }}</a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- 年份选择器 - 全展开列表 -->
      <div class="year-selector">
        <label class="section-label">按年份浏览</label>
        <div class="year-list">
          {% assign posts_by_year = site.posts | group_by_exp: "post", "post.date | date: '%Y'" %}
          {% for year_group in posts_by_year %}
          <a href="#" class="year-link" data-year="{{ year_group.name }}">{{ year_group.name }}年 ({{ year_group.items | size }}篇)</a>
          {% endfor %}
        </div>
      </div>
      
      <!-- 导航链接 -->
      <div class="nav-links">
        <label class="section-label">更多</label>
        <a href="{{ '/about' | relative_url }}" class="nav-link" data-page-url="{{ '/about' | relative_url }}">关于</a>
        <a href="/photos" class="nav-link" target="_blank" rel="noopener noreferrer">图片库</a>
      </div>
      
      <!-- 深色模式切换 -->
      <div class="theme-toggle">
        <label class="toggle-label">
          <span class="toggle-text">深色模式</span>
          <div class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="toggle-slider"></span>
          </div>
        </label>
      </div>
      
      <!-- 版权信息 -->
      <div class="copyright">
        © {{ site.name | default: site.title }}
      </div>
    </div>
  </aside>

  <!-- 主内容区 -->
  <main class="blog-main" id="blogMain">
    <!-- 文章列表视图 -->
    <div id="postsView">
      <!-- 过滤条件标题 -->
      <div id="filterHeader" class="filter-header" style="display: none;">
        <div class="filter-title-container">
          <h1 id="filterTitle" class="filter-title"></h1>
          <a href="#" id="backToHome" class="back-to-home">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            返回主页
          </a>
        </div>
      </div>
      <div id="postsContainer">
        {% for post in site.posts %}
        <article class="post-card" 
                 data-year="{{ post.date | date: '%Y' }}" 
                 data-tags="{{ post.tags | join: ',' }}" 
                 data-url="{{ post.url | relative_url }}"
                 data-post-index="{{ forloop.index0 }}">
          <a href="{{ post.url | relative_url }}" class="post-card-link">
            {% if post.image %}
            <div class="post-card-image">
              <img src="{{ post.image | relative_url }}" alt="{{ post.title }}" loading="lazy">
            </div>
            {% endif %}
            <div class="post-card-content">
              <h2 class="post-card-title">{{ post.title }}</h2>
              <div class="post-card-meta">
                <span class="post-card-date">{{ post.date | date: "%Y-%m-%d" }}</span>
                {% if post.tags.size > 0 %}
                <span class="post-card-tags">
                  {% for tag in post.tags limit: 3 %}
                  <span class="post-tag">#{{ tag }}</span>
                  {% endfor %}
                </span>
                {% endif %}
              </div>
              {% if post.excerpt %}
              <p class="post-card-excerpt">{{ post.excerpt | strip_html | truncatewords: 30 }}</p>
              {% endif %}
            </div>
          </a>
        </article>
        {% endfor %}
      </div>
      
      <div id="loadingIndicator" class="loading" style="display: none;">
        正在加载更多文章...
      </div>
      
      <div id="noMorePosts" class="no-more" style="display: none;">
        没有更多文章了
      </div>
    </div>

    <!-- 文章/页面详情视图 -->
    <div id="postView" style="display: none;">
      <div class="post-detail-header">
        <button id="backToList" class="back-button">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          返回列表
        </button>
      </div>
      
      <div id="postContent" class="post-detail-wrapper">
        <div class="loading">正在加载内容...</div>
      </div>
    </div>
  </main>
</div>

<!-- 移动端标题栏 -->
<div class="mobile-header">
  <div class="mobile-header-logo">
    <a href="{{ site.url }}">
      <img src="{{ '/assets/logo.png' | relative_url }}" alt="{{ site.title }}" class="logo-image">
    </a>
    <a href="{{ site.url }}" class="logo-text">{{ site.title }}</a>
  </div>
  <button class="hamburger-button" id="hamburgerButton" aria-label="打开菜单">
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
    <span class="hamburger-line"></span>
  </button>
</div>

<!-- 移动端遮罩层 -->
<div class="sidebar-overlay" id="sidebarOverlay">
  <button class="close-button" id="closeButton" aria-label="关闭菜单">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</div>

<!-- 隐藏的文章数据 -->
<script id="postsData" type="application/json">
[
  {% for post in site.posts %}
  {
    "title": {{ post.title | jsonify }},
    "url": "{{ post.url | relative_url }}",
    "date": "{{ post.date | date: '%Y-%m-%d' }}",
    "author": "{{ post.author | default: site.author }}",
    "tags": {{ post.tags | jsonify }},
    "image": "{{ post.image | relative_url }}",
    "excerpt": {{ post.excerpt | strip_html | truncatewords: 30 | jsonify }},
    "year": "{{ post.date | date: '%Y' }}",
    "next": {% if post.next %}{"title": {{ post.next.title | jsonify }}, "url": "{{ post.next.url | relative_url }}"}{% else %}null{% endif %},
    "previous": {% if post.previous %}{"title": {{ post.previous.title | jsonify }}, "url": "{{ post.previous.url | relative_url }}"}{% else %}null{% endif %}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
]
</script>

<script>
// 全局变量
let allPosts = [];
let postsMetadata = [];
let filteredPosts = [];
let currentFilter = { type: null, value: null };
let displayedCount = 12;
const postsPerLoad = 12;
let currentPostIndex = -1;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing blog...');
  
  // 加载文章元数据
  loadPostsMetadata();
  
  // 收集所有文章数据
  collectAllPosts();
  
  // 绑定事件
  bindEvents();
  
  // 初始化无限滚动
  initInfiniteScroll();
  
  // 初始渲染
  renderPosts();
  
  console.log('Blog initialized with', allPosts.length, 'posts');
});

// 加载文章元数据
function loadPostsMetadata() {
  const dataScript = document.getElementById('postsData');
  if (dataScript) {
    postsMetadata = JSON.parse(dataScript.textContent);
    console.log('Loaded metadata for', postsMetadata.length, 'posts');
  }
}

// 收集所有文章数据
function collectAllPosts() {
  const postCards = document.querySelectorAll('.post-card');
  allPosts = Array.from(postCards).map(card => ({
    element: card,
    year: card.dataset.year,
    tags: card.dataset.tags ? card.dataset.tags.split(',').filter(t => t) : [],
    title: card.querySelector('.post-card-title').textContent.toLowerCase(),
    excerpt: card.querySelector('.post-card-excerpt')?.textContent.toLowerCase() || '',
    url: card.dataset.url,
    index: parseInt(card.dataset.postIndex)
  }));
  filteredPosts = [...allPosts];
}

// 绑定事件
function bindEvents() {
  // 搜索
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', debounce(handleSearch, 300));
  }
  
  // 标签点击
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const tag = e.target.dataset.tag;
      
      // 如果当前在文章页，先返回列表
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        showPostsList();
      }
      
      handleTagClick(tag, e.target);
    });
  });
  
  // 年份链接点击
  document.querySelectorAll('.year-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const year = e.target.dataset.year;
      
      // 如果当前在文章页，先返回列表
      const postView = document.getElementById('postView');
      if (postView && postView.style.display !== 'none') {
        showPostsList();
      }
      
      handleYearClick(year);
    });
  });
  
  // 导航链接点击（about等页面）
  document.querySelectorAll('.nav-link[data-page-url]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const url = e.target.dataset.pageUrl;
      loadPageContent(url, e.target.textContent);
    });
  });
  
  // 文章卡片点击
  document.addEventListener('click', (e) => {
    const postLink = e.target.closest('.post-card-link');
    if (postLink) {
      e.preventDefault();
      const postCard = postLink.closest('.post-card');
      const postIndex = parseInt(postCard.dataset.postIndex);
      loadPostContent(postIndex);
    }
  });
  
  // 返回列表按钮
  const backToList = document.getElementById('backToList');
  if (backToList) {
    backToList.addEventListener('click', showPostsList);
  }
  
  // 返回主页按钮
  const backToHome = document.getElementById('backToHome');
  if (backToHome) {
    backToHome.addEventListener('click', (e) => {
      e.preventDefault();
      resetToHome();
    });
  }
  
  // 移动端菜单
  const hamburgerButton = document.getElementById('hamburgerButton');
  if (hamburgerButton) {
    hamburgerButton.addEventListener('click', toggleMobileSidebar);
  }
  
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', (e) => {
      if (e.target === sidebarOverlay) {
        closeMobileSidebar();
      }
    });
  }
  
  const closeButton = document.getElementById('closeButton');
  if (closeButton) {
    closeButton.addEventListener('click', closeMobileSidebar);
  }
}

// 搜索处理
function handleSearch(e) {
  const query = e.target.value.toLowerCase().trim();
  
  // 如果当前在文章页，先返回列表
  const postView = document.getElementById('postView');
  if (postView && postView.style.display !== 'none') {
    showPostsList();
  }
  
  if (query === '') {
    if (currentFilter.type) {
      applyFilter(currentFilter.type, currentFilter.value);
    } else {
      filteredPosts = [...allPosts];
      displayedCount = 12;
      renderPosts();
    }
    return;
  }
  
  currentFilter = { type: 'search', value: query };
  filteredPosts = allPosts.filter(post => 
    post.title.includes(query) || post.excerpt.includes(query)
  );
  
  displayedCount = Math.min(12, filteredPosts.length);
  updateFilterHeader('search', query);
  renderPosts();
  
  // 更新浏览器历史 - 使用主页路径
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('search', query);
  const title = `搜索：${query}`;
  window.history.pushState({ type: 'search', value: query }, title, url);
  document.title = `${title} - {{ site.title }}`;
}
}

// 标签点击处理
function handleTagClick(tag, element) {
  const wasActive = element.classList.contains('active');
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  if (wasActive) {
    currentFilter = { type: null, value: null };
    filteredPosts = [...allPosts];
    displayedCount = 12;
    updateFilterHeader(null, null);
    
    // 返回主页，清除URL参数
    window.history.pushState({ type: null }, '{{ site.title }}', '/');
    document.title = '{{ site.title }}';
  } else {
    element.classList.add('active');
    currentFilter = { type: 'tag', value: tag };
    filteredPosts = allPosts.filter(post => post.tags.includes(tag));
    displayedCount = Math.min(12, filteredPosts.length);
    updateFilterHeader('tag', tag);
    
    // 更新浏览器历史 - 使用主页路径
    const url = new URL(window.location.origin + '/');
    url.searchParams.set('tag', tag);
    const title = `标签：${tag}`;
    window.history.pushState({ type: 'tag', value: tag }, title, url);
    document.title = `${title} - {{ site.title }}`;
  }
  
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  renderPosts();
}

// 年份点击处理
function handleYearClick(year) {
  currentFilter = { type: 'year', value: year };
  filteredPosts = allPosts.filter(post => post.year === year);
  displayedCount = Math.min(12, filteredPosts.length);
  
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  updateFilterHeader('year', year);
  renderPosts();
  closeMobileSidebar();
  
  // 更新浏览器历史 - 使用主页路径
  const url = new URL(window.location.origin + '/');
  url.searchParams.set('year', year);
  const title = `${year}年文章`;
  window.history.pushState({ type: 'year', value: year }, title, url);
  document.title = `${title} - {{ site.title }}`;
}

// 从文章页点击标签的处理
function handleTagClickFromPost(tag) {
  // 关闭文章详情页，返回列表
  showPostsList();
  
  // 应用标签筛选
  currentFilter = { type: 'tag', value: tag };
  filteredPosts = allPosts.filter(post => post.tags.includes(tag));
  displayedCount = Math.min(12, filteredPosts.length);
  
  // 清空搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  // 高亮对应的标签按钮
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tag === tag) {
      btn.classList.add('active');
    }
  });
  
  renderPosts();
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
}

// 渲染文章列表
function renderPosts() {
  allPosts.forEach(post => {
    post.element.style.display = 'none';
  });
  
  const postsToShow = filteredPosts.slice(0, displayedCount);
  postsToShow.forEach(post => {
    post.element.style.display = 'block';
  });
  
  const noMorePosts = document.getElementById('noMorePosts');
  if (displayedCount >= filteredPosts.length) {
    noMorePosts.style.display = filteredPosts.length === 0 ? 'none' : 'block';
  } else {
    noMorePosts.style.display = 'none';
  }
}

// 无限滚动
function initInfiniteScroll() {
  const blogMain = document.getElementById('blogMain');
  
  blogMain.addEventListener('scroll', () => {
    const postsView = document.getElementById('postsView');
    if (postsView.style.display === 'none') return;
    
    const scrollTop = blogMain.scrollTop;
    const scrollHeight = blogMain.scrollHeight;
    const clientHeight = blogMain.clientHeight;
    
    if (scrollHeight - scrollTop - clientHeight < 200) {
      loadMorePosts();
    }
  });
}

// 加载更多文章
let isLoading = false;
function loadMorePosts() {
  if (isLoading || displayedCount >= filteredPosts.length) return;
  
  isLoading = true;
  const loadingIndicator = document.getElementById('loadingIndicator');
  loadingIndicator.style.display = 'block';
  
  setTimeout(() => {
    displayedCount = Math.min(displayedCount + postsPerLoad, filteredPosts.length);
    renderPosts();
    loadingIndicator.style.display = 'none';
    isLoading = false;
  }, 300);
}

// 加载页面内容（about等静态页面）
async function loadPageContent(url, title) {
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const postContent = document.getElementById('postContent');
  const blogMain = document.getElementById('blogMain');
  
  // 切换视图
  postsView.style.display = 'none';
  postView.style.display = 'block';
  blogMain.scrollTop = 0;
  
  // 更新浏览器URL和标题
  window.history.pushState(
    { type: 'page', url: url, title: title },
    title,
    url
  );
  document.title = `${title} - {{ site.title }}`;
  
  // 显示加载状态
  postContent.innerHTML = '<div class="loading">正在加载内容...</div>';
  
  try {
    const response = await fetch(url);
    const html = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 提取页面内容
    const article = doc.querySelector('article') || doc.querySelector('.prose') || doc.querySelector('main');
    
    if (article) {
      renderPageDetail(title, url, article.innerHTML);
    } else {
      postContent.innerHTML = '<div class="error">无法加载页面内容</div>';
    }
    
    closeMobileSidebar();
  } catch (error) {
    console.error('Failed to load page:', error);
    postContent.innerHTML = '<div class="error">加载失败，请刷新重试</div>';
  }
}

// 渲染页面详情
function renderPageDetail(title, url, content) {
  const postContent = document.getElementById('postContent');
  
  let html = '<div class="post-detail-container">';
  
  // 页面头部
  html += '<div class="post-detail-head">';
  html += `<h1 class="post-detail-title">${title}</h1>`;
  html += '</div>';
  
  // 页面内容
  html += `<div class="post-detail-article">${content}</div>`;
  
  // 分享按钮
  html += renderShareButtons({title: title, url: url});
  
  // 评论系统
  html += renderCommentSystem(url);
  
  html += '</div>';
  
  postContent.innerHTML = html;
}

// 加载文章内容
async function loadPostContent(postIndex) {
  currentPostIndex = postIndex;
  const post = postsMetadata[postIndex];
  
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const postContent = document.getElementById('postContent');
  const blogMain = document.getElementById('blogMain');
  
  // 切换视图
  postsView.style.display = 'none';
  postView.style.display = 'block';
  blogMain.scrollTop = 0;
  
  // 更新浏览器URL
  window.history.pushState(
    { type: 'post', postIndex: postIndex },
    post.title,
    post.url
  );
  
  // 显示加载状态
  postContent.innerHTML = '<div class="loading">正在加载文章...</div>';
  
  try {
    // 获取文章内容
    const response = await fetch(post.url);
    const html = await response.text();
    
    // 解析HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 提取文章内容
    const article = doc.querySelector('article') || doc.querySelector('.prose');
    
    if (article) {
      // 构建完整的文章详情页
      renderPostDetail(post, article.innerHTML);
    } else {
      postContent.innerHTML = '<div class="error">无法加载文章内容</div>';
    }
  } catch (error) {
    console.error('Failed to load post:', error);
    postContent.innerHTML = '<div class="error">加载失败，请刷新重试</div>';
  }
}

// 渲染文章详情
function renderPostDetail(post, articleContent) {
  const postContent = document.getElementById('postContent');
  
  let html = '<div class="post-detail-container">';
  
  // 文章头部
  html += '<div class="post-detail-head">';
  html += `<h1 class="post-detail-title">${post.title}</h1>`;
  html += '<div class="post-detail-meta">';
  html += `<span class="post-detail-author">${post.author}</span>`;
  html += `<span class="post-detail-date">${post.date}</span>`;
  html += '</div>';
  
  // 标签
  if (post.tags && post.tags.length > 0) {
    html += '<div class="post-detail-tags">';
    post.tags.forEach(tag => {
      html += `<a href="#" class="post-detail-tag" data-tag="${tag}" onclick="event.preventDefault(); handleTagClickFromPost('${tag}')">#${tag}</a>`;
    });
    html += '</div>';
  }
  html += '</div>';
  
  // 题图
  if (post.image && post.image !== '/') {
    html += `<div class="post-detail-image"><img src="${post.image}" alt="${post.title}"></div>`;
  }
  
  // 文章内容
  html += `<div class="post-detail-article">${articleContent}</div>`;
  
  // 分享按钮
  html += renderShareButtons(post);
  
  // 上一篇/下一篇导航
  html += renderPostNavigation(post);
  
  // 评论系统
  html += renderCommentSystem(post.url);
  
  html += '</div>';
  
  postContent.innerHTML = html;
}

// 渲染分享按钮
function renderShareButtons(post) {
  const url = encodeURIComponent(window.location.origin + post.url);
  const title = encodeURIComponent(post.title);
  
  let html = '<div class="share-buttons">';
  html += '<div class="share-label">分享到：</div>';
  html += '<div class="share-buttons-container">';
  
  // 微博
  html += `<a href="https://service.weibo.com/share/share.php?url=${url}&title=${title}" target="_blank" rel="noopener noreferrer" class="share-btn share-weibo" title="分享到微博">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.194 14.197c-.402 1.092-1.634 1.594-2.761 1.123-1.126-.471-1.535-1.797-1.133-2.889.403-1.092 1.634-1.594 2.761-1.123 1.126.471 1.535 1.797 1.133 2.889zm-4.402-2.107c-.201.546-.817.797-1.381.562-.563-.235-.768-.898-.567-1.444.201-.546.817-.797 1.381-.562.563.235.768.898.567 1.444zm7.208 1.91c0 4.418-5.373 8-12 8s-12-3.582-12-8c0-1.5.568-2.898 1.548-4.129C2.537 7.697 4.179 6 6.545 6c1.635 0 3.087.691 4.091 1.772.904-.447 1.906-.697 2.955-.697 3.866 0 7 2.686 7 6 0 .343-.034.68-.1 1.009.668.542 1.109 1.346 1.109 2.241z"/></svg>
    微博
  </a>`;
  
  // Twitter
  html += `<a href="https://twitter.com/intent/tweet?url=${url}&text=${title}" target="_blank" rel="noopener noreferrer" class="share-btn share-twitter" title="分享到Twitter">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
    Twitter
  </a>`;
  
  // Facebook
  html += `<a href="https://www.facebook.com/sharer/sharer.php?u=${url}" target="_blank" rel="noopener noreferrer" class="share-btn share-facebook" title="分享到Facebook">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
    Facebook
  </a>`;
  
  // 微信
  html += `<button class="share-btn share-wechat" onclick="alert('请使用微信扫一扫分享')" title="分享到微信">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-5.523 3.317-6.523 1.961-.62 3.756-.31 5.164.403.278-3.701-3.315-6.512-8.292-6.512zm-2.43 4.645a.97.97 0 0 1 .972.972.97.97 0 0 1-.972.972.97.97 0 0 1-.972-.972.97.97 0 0 1 .972-.972zm5.641 0a.97.97 0 0 1 .972.972.97.97 0 0 1-.972.972.97.97 0 0 1-.972-.972.97.97 0 0 1 .972-.972z"/><path d="M15.314 9.403c-3.707 0-6.713 2.462-6.713 5.5 0 1.665.927 3.156 2.383 4.167.091.063.156.15.169.25l-.296 1.11c-.015.053-.038.107-.038.161 0 .122.098.223.218.223a.25.25 0 0 0 .126-.041l1.427-.834a.65.65 0 0 1 .538-.074c.584.16 1.201.241 1.834.241 3.707 0 6.713-2.462 6.713-5.5s-3.006-5.5-6.713-5.5zm-1.834 3.444a.73.73 0 0 1 .731.731.73.73 0 0 1-.731.731.73.73 0 0 1-.731-.731.73.73 0 0 1 .731-.731zm3.669 0a.73.73 0 0 1 .731.731.73.73 0 0 1-.731.731.73.73 0 0 1-.731-.731.73.73 0 0 1 .731-.731z"/></svg>
    微信
  </button>`;
  
  // 复制链接
  html += `<button class="share-btn share-copy" onclick="copyPostLink('${post.url}')" title="复制链接">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    复制链接
  </button>`;
  
  html += '</div></div>';
  
  return html;
}

// 复制链接函数
function copyPostLink(url) {
  const fullUrl = window.location.origin + url;
  navigator.clipboard.writeText(fullUrl).then(() => {
    alert('链接已复制到剪贴板');
  }).catch(() => {
    alert('复制失败，请手动复制：' + fullUrl);
  });
}

// 渲染文章导航
function renderPostNavigation(post) {
  let html = '<div class="post-navigation">';
  
  if (post.previous) {
    html += `<a href="#" class="post-nav-link post-nav-prev" onclick="event.preventDefault(); loadPostByUrl('${post.previous.url}')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.1795 3.26875C15.7889 2.87823 15.1558 2.87823 14.7652 3.26875L8.12078 9.91322C6.94952 11.0845 6.94916 12.9833 8.11996 14.155L14.6903 20.7304C15.0808 21.121 15.714 21.121 16.1045 20.7304C16.495 20.3399 16.495 19.7067 16.1045 19.3162L9.53246 12.7442C9.14194 12.3536 9.14194 11.7205 9.53246 11.33L16.1795 4.68297C16.57 4.29244 16.57 3.65928 16.1795 3.26875Z"></path></svg>
      <span>${post.previous.title}</span>
    </a>`;
  }
  
  if (post.next) {
    html += `<a href="#" class="post-nav-link post-nav-next" onclick="event.preventDefault(); loadPostByUrl('${post.next.url}')">
      <span>${post.next.title}</span>
      <svg viewBox="0 0 24 24" fill="currentColor" transform="rotate(180)"><path d="M16.1795 3.26875C15.7889 2.87823 15.1558 2.87823 14.7652 3.26875L8.12078 9.91322C6.94952 11.0845 6.94916 12.9833 8.11996 14.155L14.6903 20.7304C15.0808 21.121 15.714 21.121 16.1045 20.7304C16.495 20.3399 16.495 19.7067 16.1045 19.3162L9.53246 12.7442C9.14194 12.3536 9.14194 11.7205 9.53246 11.33L16.1795 4.68297C16.57 4.29244 16.57 3.65928 16.1795 3.26875Z"></path></svg>
    </a>`;
  }
  
  html += '</div>';
  
  return html;
}

// 通过URL加载文章
function loadPostByUrl(url) {
  const index = postsMetadata.findIndex(p => p.url === url);
  if (index !== -1) {
    loadPostContent(index);
  }
}

// 渲染评论系统
function renderCommentSystem(pathname) {
  let html = '<div class="comments-section">';
  html += '<h3 class="comments-title">评论</h3>';
  html += '<div class="giscus-container"></div>';
  html += '</div>';
  
  // 延迟加载giscus
  setTimeout(() => {
    loadGiscus(pathname);
  }, 500);
  
  return html;
}

// 加载giscus评论系统
function loadGiscus(pathname) {
  const container = document.querySelector('.giscus-container');
  if (!container) return;
  
  // 清空容器
  container.innerHTML = '';
  
  // 创建script标签
  const script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', 'lishuhang/lishuhang.github.io');
  script.setAttribute('data-repo-id', 'R_kgDOKbcVHw');
  script.setAttribute('data-category', 'Announcements');
  script.setAttribute('data-category-id', 'DIC_kwDOKbcVH84CwoJY');
  script.setAttribute('data-mapping', 'specific');
  script.setAttribute('data-term', pathname);
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'bottom');
  script.setAttribute('data-theme', 'preferred_color_scheme');
  script.setAttribute('data-lang', 'zh-CN');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  
  container.appendChild(script);
}

// 显示文章列表
function showPostsList() {
  const postsView = document.getElementById('postsView');
  const postView = document.getElementById('postView');
  const blogMain = document.getElementById('blogMain');
  
  postView.style.display = 'none';
  postsView.style.display = 'block';
  blogMain.scrollTop = 0;
  
  currentPostIndex = -1;
  
  // 更新URL为当前筛选状态
  if (currentFilter.type) {
    const url = new URL(window.location.origin + '/');
    url.searchParams.set(currentFilter.type, currentFilter.value);
    let title = '';
    if (currentFilter.type === 'year') {
      title = `${currentFilter.value}年文章`;
    } else if (currentFilter.type === 'tag') {
      title = `标签：${currentFilter.value}`;
    } else if (currentFilter.type === 'search') {
      title = `搜索：${currentFilter.value}`;
    }
    window.history.pushState(
      { type: currentFilter.type, value: currentFilter.value },
      title,
      url
    );
    document.title = `${title} - {{ site.title }}`;
  } else {
    window.history.pushState({ type: null }, '{{ site.title }}', '/');
    document.title = '{{ site.title }}';
  }
}

// 移动端侧边栏控制
function toggleMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
  document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
}

function closeMobileSidebar() {
  const sidebar = document.getElementById('blogSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 更新过滤条件标题
function updateFilterHeader(type, value) {
  const filterHeader = document.getElementById('filterHeader');
  const filterTitle = document.getElementById('filterTitle');
  
  if (!type || !value) {
    filterHeader.style.display = 'none';
    return;
  }
  
  let title = '';
  if (type === 'year') {
    title = `${value}年文章`;
  } else if (type === 'tag') {
    title = `标签：${value}`;
  } else if (type === 'search') {
    title = `搜索：${value}`;
  }
  
  filterTitle.textContent = title;
  filterHeader.style.display = 'block';
}

// 返回主页
function resetToHome() {
  // 清除所有筛选
  currentFilter = { type: null, value: null };
  filteredPosts = [...allPosts];
  displayedCount = 12;
  
  // 清除搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  
  // 清除标签高亮
  document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
  
  // 隐藏过滤标题
  updateFilterHeader(null, null);
  
  // 重新渲染列表
  renderPosts();
  
  // 更新URL为主页
  window.history.pushState({ type: null }, '{{ site.title }}', '/');
  document.title = '{{ site.title }}';
  
  // 滚动到顶部
  const blogMain = document.getElementById('blogMain');
  if (blogMain) blogMain.scrollTop = 0;
}

// 处理浏览器前进后退
window.addEventListener('popstate', (event) => {
  if (event.state) {
    if (event.state.type === 'post') {
      // 加载文章
      loadPostContent(event.state.postIndex);
    } else if (event.state.type === 'tag') {
      // 应用标签筛选
      const tagBtn = document.querySelector(`.tag-btn[data-tag="${event.state.value}"]`);
      if (tagBtn) {
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
        tagBtn.classList.add('active');
      }
      currentFilter = { type: 'tag', value: event.state.value };
      filteredPosts = allPosts.filter(post => post.tags.includes(event.state.value));
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('tag', event.state.value);
      renderPosts();
      showPostsList();
      document.title = `标签：${event.state.value} - {{ site.title }}`;
    } else if (event.state.type === 'year') {
      // 应用年份筛选
      currentFilter = { type: 'year', value: event.state.value };
      filteredPosts = allPosts.filter(post => post.year === event.state.value);
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('year', event.state.value);
      renderPosts();
      showPostsList();
      document.title = `${event.state.value}年文章 - {{ site.title }}`;
    } else if (event.state.type === 'search') {
      // 应用搜索
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = event.state.value;
      currentFilter = { type: 'search', value: event.state.value };
      filteredPosts = allPosts.filter(post => 
        post.title.includes(event.state.value.toLowerCase()) || 
        post.excerpt.includes(event.state.value.toLowerCase())
      );
      displayedCount = Math.min(12, filteredPosts.length);
      updateFilterHeader('search', event.state.value);
      renderPosts();
      showPostsList();
      document.title = `搜索：${event.state.value} - {{ site.title }}`;
    } else if (event.state.type === 'page') {
      // 加载静态页面
      loadPageContent(event.state.url, event.state.title);
    } else {
      // 返回主页
      resetToHome();
    }
  } else {
    // 没有state，返回主页
    resetToHome();
  }
});

// 页面初始加载时设置初始状态
window.addEventListener('load', () => {
  // 设置初始状态
  window.history.replaceState({ type: null }, document.title, window.location.pathname + window.location.search);
});

// ===== 深色模式功能 =====

// 初始化深色模式
function initDarkMode() {
  const darkModeToggle = document.getElementById('darkModeToggle');
  if (!darkModeToggle) return;
  
  // 检查用户之前的选择
  const savedTheme = localStorage.getItem('theme');
  
  if (savedTheme) {
    // 如果用户之前选择过，使用保存的设置
    applyTheme(savedTheme);
    darkModeToggle.checked = savedTheme === 'dark';
  } else {
    // 否则跟随系统设置
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = prefersDark ? 'dark' : 'light';
    applyTheme(theme);
    darkModeToggle.checked = prefersDark;
  }
  
  // 监听切换按钮
  darkModeToggle.addEventListener('change', (e) => {
    const theme = e.target.checked ? 'dark' : 'light';
    applyTheme(theme);
    localStorage.setItem('theme', theme);
  });
  
  // 监听系统主题变化（仅当用户未手动设置时）
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      const theme = e.matches ? 'dark' : 'light';
      applyTheme(theme);
      darkModeToggle.checked = e.matches;
    }
  });
}

// 应用主题
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  
  // 更新 giscus 评论系统主题
  const giscusFrame = document.querySelector('iframe.giscus-frame');
  if (giscusFrame) {
    const giscusTheme = theme === 'dark' ? 'dark' : 'light';
    giscusFrame.contentWindow.postMessage(
      { giscus: { setConfig: { theme: giscusTheme } } },
      'https://giscus.app'
    );
  }
}

// 在 DOM 加载完成后初始化深色模式
document.addEventListener('DOMContentLoaded', initDarkMode);
</script>

